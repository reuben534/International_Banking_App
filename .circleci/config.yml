version: 2.1

jobs:
  build_and_analyze:
    machine:
      image: ubuntu-2204:current # Runs directly on Ubuntu VM (no Docker)
    steps:
      - checkout

      # Install Node.js and npm
      - run:
          name: Install Node.js and npm
          command: |
            sudo apt update
            sudo apt install -y curl
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt install -y nodejs
            node -v
            npm -v

      # Install dependencies
      - run:
          name: Install Project Dependencies
          command: npm install

      # Optional: run your Angular build
      - run:
          name: Build Angular Project
          command: npm run build --if-present

      # Install sonar-scanner globally
      - run:
          name: Install Sonar Scanner
          command: sudo npm install -g sonar-scanner

      # Run SonarQube static code analysis
      - run:
          name: Run SonarQube Scan
          command: |
            sonar-scanner \
              -Dsonar.projectKey=InternationalBankingApp \
              -Dsonar.organization=reuben534\
              -Dsonar.sources=src \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.login=$SONAR_TOKEN

workflows:
  build_and_scan:
    jobs:
      - build_and_analyze
