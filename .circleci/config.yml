version: 2.1

jobs:
  build_and_analyze:
    machine:
      image: ubuntu-2204:current

    steps:
      - checkout

      # Install Node.js and npm
      - run:
          name: Install Node.js and npm
          command: |
            sudo apt update
            sudo apt install -y curl
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt install -y nodejs
            node -v
            npm -v

      # ==== Backend (server) ====
      - run:
          name: Install Server Dependencies
          command: |
            cd server
            npm install

      - run:
          name: Build Server
          command: |
            cd server
            npm run build --if-present

      # ==== Frontend (client) ====
      - run:
          name: Install Client Dependencies
          command: |
            cd client
            npm install

      - run:
          name: Build React App
          command: |
            cd client
            npm run build --if-present

      # ==== SonarQube Analysis ====
      - run:
          name: Install Sonar Scanner
          command: sudo npm install -g sonar-scanner

      - run:
          name: Run SonarQube Scan
          command: |
            echo "Running SonarCloud analysis..."
            sonar-scanner \
              -Dsonar.projectKey=reuben534_International_Banking_App \
              -Dsonar.organization=reuben534 \
              -Dsonar.sources=client/src,server \
              -Dsonar.sourceEncoding=UTF-8 \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.token=${SONAR_TOKEN}

workflows:
  build_and_scan:
    jobs:
      - build_and_analyze
